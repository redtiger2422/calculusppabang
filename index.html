<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>타요 & 티니핑 수학 모험</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(120deg, #a1e0ff 40%, #f9e0ff 100%);
      box-sizing: border-box;
      font-family: 'Spoqa Han Sans Neo', 'Noto Sans KR', Arial, sans-serif;
    }
    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    #openingVideo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #openingVideo video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    #openingVideoPlayer {
      width: 100%;
      height: 100%;
      max-width: 1280px;
      max-height: 720px;
    }
    
    #skipButton {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.8);
      color: #333;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      z-index: 1001;
      transition: background 0.3s;
    }
    
    #skipButton:hover {
      background: rgba(255, 255, 255, 0.95);
    }
    
    #soundButton {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(102, 181, 246, 0.9);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      z-index: 1001;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    #soundButton:hover {
      background: rgba(61, 151, 224, 0.95);
      transform: translateX(-50%) scale(1.05);
    }
    
    /* 축하 메시지 모달 스타일 */
    #congratsModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    
    #congratsBox {
      background: linear-gradient(135deg, #fff 0%, #ffd6f3 100%);
      border-radius: 25px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
      animation: bounceIn 0.6s ease-out;
      max-width: 90%;
      width: 450px;
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    #congratsMessage {
      font-size: 26px;
      font-weight: bold;
      color: #ff1493;
      margin-bottom: 30px;
      line-height: 1.5;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    #giftButton {
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: white;
      font-size: 20px;
      font-weight: bold;
      padding: 15px 40px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #giftButton:hover {
      background: linear-gradient(45deg, #ff5252, #ff7043);
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(255, 107, 107, 0.6);
    }
    
    .gift-emoji {
      font-size: 50px;
      margin: 20px 0;
      animation: rotate 3s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* 축하 비디오 스타일 */
    #celebrationVideo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #celebrationPlayer {
      width: 100%;
      height: 100%;
      max-width: 1280px;
      max-height: 720px;
    }
    
    .celebration-text {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #FFD700;
      font-size: 28px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      animation: sparkle 1.5s ease-in-out infinite;
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    #closeVideoBtn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 100, 100, 0.9);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      z-index: 1001;
      transition: all 0.3s;
    }
    
    #closeVideoBtn:hover {
      background: rgba(255, 50, 50, 0.95);
      transform: translateX(-50%) scale(1.05);
    }
    
    #gameContainer {
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    #gameBox {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      box-shadow: 0 6px 40px rgba(20,60,160,0.17);
      padding: 32px 24px 20px 24px;
      max-width: 420px;
      min-width: 330px;
      width: 90vw;
      margin: 0 auto;
      position: relative;
      text-align: center;
    }
    #logoImages {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 10px;
      margin-bottom: 12px;
    }
    .logo-char {
      height: 60px;
      border-radius: 10px;
      object-fit: contain;
      box-shadow: 0 3px 15px rgba(30,70,180,0.11);
      background: #eaf6ff;
      padding: 3px;
    }
    #adventureMsg {
      margin-bottom: 12px;
    }
    #adventureMsg div {
      color: #3186eb;
      font-size: 1.32em;
      font-weight: bold;
      letter-spacing: 1px;
      text-shadow: 0 1px 5px #fff6;
      animation: bounce 2.2s infinite;
      margin: 4px 0;
    }
    @keyframes bounce {
      0% { transform: translateY(0); }
      15% { transform: translateY(-6px); }
      30% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
      70% { transform: translateY(0); }
    }
    label, select, button, input {
      font-size: 1.15em;
    }
    select, input {
      padding: 7px 12px;
      border-radius: 6px;
      border: 1.2px solid #aad3fd;
      margin-bottom: 12px;
      width: 70%;
      max-width: 200px;
      background: #f5fbff;
    }
    button {
      margin-top: 5px;
      background: #66b5f6;
      color: white;
      font-weight: bold;
      padding: 8px 24px;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      box-shadow: 0 2px 7px #88c6fc55;
      transition: background 0.2s;
    }
    button:hover { background: #3d97e0; }
    #questionNum {
      font-size: 1.07em;
      color: #9791cf;
      margin-bottom: 5px;
    }
    #questionText {
      font-size: 1.6em;
      font-weight: bold;
      color: #3677b6;
      margin-bottom: 18px;
      margin-top: 0;
    }
    #answerInput {
      text-align: center;
      font-weight: bold;
      letter-spacing: 1px;
    }
    #feedback {
      min-height: 1.1em;
      font-size: 1.13em;
      font-weight: 500;
      margin: 7px 0 0 0;
      color: #fa7e2e;
    }
    #mathTip {
      background: linear-gradient(135deg, #e3f2fd 0%, #f8e8ff 100%);
      border-left: 4px solid #3186eb;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      text-align: left;
      font-size: 0.95em;
      color: #3677b6;
      display: none;
      line-height: 1.4;
    }
    #resultSection {
      margin: 0 0 10px 0;
    }
    #resultSection h2 {
      color: #3a7fbc;
      margin-bottom: 5px;
    }
    #resultMsg {
      font-size: 1.14em;
      margin: 12px 0 8px 0;
      color: #6864e2;
    }
    #madeBy {
      font-size: 0.99em;
      color: #aaa;
      margin-top: 18px;
      letter-spacing: 1.5px;
      text-align: center;
      width: 100%;
      position: relative;
    }
    #muteBtn {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.45em;
      cursor: pointer;
      z-index: 99;
      color: #3186eb;
      user-select: none;
      padding: 0;
    }
    @media (max-width: 500px) {
      #gameBox {
        min-width: unset;
        padding: 8vw 2vw 5vw 2vw;
      }
      .logo-char {
        height: 44px;
      }
      #muteBtn {
        right: 10px;
        top: 8px;
      }
      #skipButton {
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        font-size: 12px;
      }
      #soundButton, #closeVideoBtn {
        bottom: 10px;
        padding: 10px 20px;
        font-size: 14px;
      }
      .celebration-text {
        font-size: 20px;
      }
      #congratsBox {
        padding: 30px;
        width: 90%;
      }
      #congratsMessage {
        font-size: 20px;
      }
      #giftButton {
        font-size: 16px;
        padding: 12px 30px;
      }
      .gift-emoji {
        font-size: 40px;
      }
      #mathTip {
        font-size: 0.9em;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- 오프닝 비디오 섹션 -->
  <div id="openingVideo">
    <video id="openingVideoPlayer" autoplay>
      <source src="openvd.mp4" type="video/mp4">
      브라우저가 비디오를 지원하지 않습니다.
    </video>
    <button id="skipButton">건너뛰기</button>
  </div>

  <!-- 게임 컨테이너 -->
  <div id="gameContainer" style="display: none;">
    <div id="gameBox">
      <button id="muteBtn" title="음소거 전환">🔊</button>
      <div id="logoImages">
        <img src="티니핑공주.png" alt="티니핑공주" class="logo-char" onerror="this.style.display='none'">
        <img src="타요자동차.png" alt="타요자동차" class="logo-char" onerror="this.style.display='none'">
      </div>
      <div id="adventureMsg">
        <div>💡 신나는 타요와 티니핑의 수학 모험!💡</div>
        <div>🚘 지금 떠나요! 🚘</div>
      </div>
      <!-- 나이 선택 화면 -->
      <div id="ageSection">
        <label for="ageSelect">나이를 선택하세요 (3세~13세):</label><br>
        <select id="ageSelect">
          <option value="">-- 나이 선택 --</option>
          <option value="3">3세</option>
          <option value="4">4세</option>
          <option value="5">5세</option><option value="6">6세</option><option value="7">7세</option>
          <option value="8">8세</option><option value="9">9세</option><option value="10">10세</option>
          <option value="11">11세</option><option value="12">12세</option><option value="13">13세</option>
        </select>
        <br><button id="startQuizBtn">모험 시작!</button>
      </div>
      <!-- 문제 퀴즈 화면 -->
      <div id="quizSection" style="display:none;">
        <div id="questionNum"></div>
        <div id="questionText"></div>
        <input id="answerInput" type="text" autocomplete="off" placeholder="정답을 써주세요!">
        <br><button id="submitAnswerBtn">정답 확인</button>
        <div id="feedback"></div>
        <div id="mathTip"></div>
      </div>
      <!-- 결과 화면 -->
      <div id="resultSection" style="display:none;">
        <h2>🎉 모험 완료! 🎉</h2>
        <div>맞춘 개수: <span id="correctCount"></span> / <span id="totalCount"></span></div>
        <div>정답률: <span id="accuracy"></span>%</div>
        <div id="resultMsg"></div>
        <button id="retryBtn" style="display:none;">재도전하기</button>
        <button id="restartBtn">처음으로</button>
      </div>
      <div id="madeBy">Made by 적호약사</div>
    </div>
  </div>

  <!-- 축하 메시지 모달 -->
  <div id="congratsModal">
    <div id="congratsBox">
      <div class="gift-emoji">🎁</div>
      <div id="congratsMessage">
        와우! 수학 천재이신가요!?<br>
        축하 선물을 드리겠습니다~!!
      </div>
      <button id="giftButton">선물받기</button>
    </div>
  </div>

  <!-- 축하 비디오 섹션 -->
  <div id="celebrationVideo">
    <div class="celebration-text">🎉 축하합니다! 90점 이상! 🎉</div>
    <iframe id="celebrationPlayer" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen>
    </iframe>
    <button id="closeVideoBtn">게임으로 돌아가기</button>
  </div>

  <!-- 배경 음악, 효과음 -->
  <audio id="bgMusic" src="tayo1.mp3" loop></audio>
  <audio id="applauseSound" src="coin.mp3" preload="auto"></audio>
  <audio id="congratsSound" src="박수소리1.mp3" preload="auto"></audio>

  <script>
    let quiz = { age: null, questions: [], current: 0, correct: 0, consecutiveCorrect: 0, consecutiveWrong: 0 };
    let applauseCooldown = false;
    let bgMusicStarted = false;
    let isSoundOn = true;

    // 축하 영상 목록
    const celebrationVideos = [
      'yg9vV3_rVI0',
      '5chNiLy9X_A',
      'vE7tGIxzfwo',
      'HbBNNzHVLlA'
    ];

    // 정답 시 축하 메시지 (기획서 반영)
    const correctMessages = [
      "정답! 완전 천재 아니야? 🚍",
      "맞았어요! 혹시... 혹시 멘사신가요? 👑", 
      "대박! 수학 신동 등장! 🌟",
      "우와! 진짜 똑똑하다! 💎",
      "완벽해! 수학 마법사세요? ✨",
      "쩐다! 타요도 깜짝 놀랐어요! 🚌",
      "헐~ 진짜 대단한데요? 🔥",
      "와우! 이 정도면 수학 천재! 🧠",
      "멋져요! 티니핑도 박수쳐요! 👑",
      "정답! 혹시 미래의 수학자? 🎯",
      "짱이에요! 완전 수학 고수! ⭐",
      "오마이갓! 이런 실력이! 😍",
      "대단해! 어른도 못 푸는데? 💪",
      "와~ 진짜 머리 좋으시네요! 🎊",
      "정답! 수학계의 신성! 🌈",
      "크으~ 이 정도 실력이면! 🎈",
      "놀라워! 진짜 수학 영재! 🎨",
      "맞혔다! 혹시 수학 선생님? 📚",
      "쌩큐! 완전 깔끔한 정답! 🎪",
      "정말 굿! 수학 마스터! 🏆"
    ];

    // 연속 정답 시 특별 메시지
    const consecutiveMessages = [
      "연속 정답! 진짜 롤모델이세요! 🔥",
      "계속 맞히네! 수학의 신 강림! ⚡",
      "와! 연타! 이건 진짜 실력! 💥",
      "스트라이크! 무시무시한 실력! 🎯"
    ];

    // 어려운 문제 정답 시
    const hardCorrectMessages = [
      "이런 어려운 것도! 진짜 대박! 🚀",
      "헉! 이걸 맞히다니! 완전 천재! 🌟",
      "와우! 이 문제는 정말 어려운데! 🏅"
    ];

    // 오답 시 격려 메시지 (기획서 반영)
    const wrongMessages = [
      "괜찮아요! 틀리는 게 더 많이 배우는 거예요! 💪",
      "실수는 성장의 계단이에요! 다음엔 더 잘할 거예요! 🌱",
      "아쉽! 하지만 포기는 금물! 화이팅! 🔥",
      "오답도 소중한 경험! 조금만 더 생각해봐요! 🤔",
      "틀려도 괜찮아요! 배우는 과정이니까요! 📚",
      "아깝다! 조금만 더 집중하면 될 것 같은데! 👀",
      "실수는 누구나 해요! 중요한 건 다시 도전하는 거! 🚀",
      "괜찮아요! 천천히 하나씩 배워가요! 🐢",
      "틀렸지만 그래도 열심히 했어요! 👏",
      "아쉽지만 다음 문제에서 만회하자! 💫",
      "실패는 성공의 어머니! 다시 힘내요! 🌈",
      "괜찮아요! 모르는 걸 알게 된 거잖아요! 💡",
      "오답! 하지만 배움의 기회! 🎯",
      "틀려도 OK! 중요한 건 끝까지 하는 거! 🏃‍♂️",
      "아쉽! 하지만 점점 늘고 있어요! 📈"
    ];

    // 연속 오답 시 특별 격려
    const consecutiveWrongMessages = [
      "괜찮아요! 어려운 문제가 계속 나왔네요! 😊",
      "조금 어렵죠? 천천히 해봐요! 🕰️",
      "힘들어도 포기하지 마세요! 거의 다 왔어요! 🎈"
    ];

    // 수학 팁 시스템 (기획서 반영)
    const mathTips = {
      3: [
        "🧸 손가락 세기: 손가락을 하나씩 펴면서 세어보세요!\n1, 2, 3... 손가락이 바로 계산기예요!\n💡 타요 버스에서 친구들을 세는 것처럼 하나씩 세어보세요!",
        "🎈 물건으로 더하기: 블록이나 장난감으로 직접 해보세요!\n블록 2개 + 블록 1개 = 블록 3개!\n💡 눈으로 보고 만져보면서 계산하면 쉬워요!",
        "🍎 빼기는 없애기: 5개 사과에서 2개를 먹으면 몇 개가 남을까요?\n하나씩 없애면서 세어보세요!\n💡 티니핑처럼 마법으로 하나씩 사라지게 해보세요!",
        "🌟 숫자 친구 만들기: 1은 막대기, 2는 백조, 3은 귀처럼 생겼어요!\n숫자 모양을 기억하면 더 쉬워져요!\n💡 숫자들도 타요와 티니핑처럼 우리 친구예요!"
      ],
      4: [
        "🧸 손가락 세기: 손가락을 하나씩 펴면서 세어보세요!\n1, 2, 3... 손가락이 바로 계산기예요!\n💡 타요 버스에서 친구들을 세는 것처럼 하나씩 세어보세요!",
        "🎈 물건으로 더하기: 블록이나 장난감으로 직접 해보세요!\n블록 2개 + 블록 1개 = 블록 3개!\n💡 눈으로 보고 만져보면서 계산하면 쉬워요!",
        "🍎 빼기는 없애기: 5개 사과에서 2개를 먹으면 몇 개가 남을까요?\n하나씩 없애면서 세어보세요!\n💡 티니핑처럼 마법으로 하나씩 사라지게 해보세요!",
        "🌟 숫자 친구 만들기: 1은 막대기, 2는 백조, 3은 귀처럼 생겼어요!\n숫자 모양을 기억하면 더 쉬워져요!\n💡 숫자들도 타요와 티니핑처럼 우리 친구예요!"
      ],
      5: [
        "🎯 받아올림 마스터법: 일의 자리부터 10을 만들어요!\n예: 9+7 → 9+1+6 → 10+6 = 16\n💡 9에 1을 주고, 7에서 1을 빼면 10+6이 되어요!",
        "⚡ 10의 보수 활용법: 10을 만드는 짝을 찾아요!\n예: 8+5 → 8+2+3 → 10+3 = 13\n💡 8의 짝 2를 먼저 더하고, 남은 3을 더해요!",
        "🧠 암산 고수법: 큰 수에 작은 수를 하나씩 더해요!\n예: 46+8 → 46+4+4 → 50+4 = 54\n💡 먼저 50을 만들고 나머지를 더하면 쉬워요!"
      ],
      6: [
        "🎯 받아올림 마스터법: 일의 자리부터 10을 만들어요!\n예: 9+7 → 9+1+6 → 10+6 = 16\n💡 9에 1을 주고, 7에서 1을 빼면 10+6이 되어요!",
        "⚡ 10의 보수 활용법: 10을 만드는 짝을 찾아요!\n예: 8+5 → 8+2+3 → 10+3 = 13\n💡 8의 짝 2를 먼저 더하고, 남은 3을 더해요!",
        "🧠 암산 고수법: 큰 수에 작은 수를 하나씩 더해요!\n예: 46+8 → 46+4+4 → 50+4 = 54\n💡 먼저 50을 만들고 나머지를 더하면 쉬워요!"
      ],
      7: [
        "🎯 받아올림 마스터법: 일의 자리부터 10을 만들어요!\n예: 9+7 → 9+1+6 → 10+6 = 16\n💡 9에 1을 주고, 7에서 1을 빼면 10+6이 되어요!",
        "🎭 받아내림 없애기: 양쪽에서 같은 수를 더하거나 빼요!\n예: 52-35 → (52-2)-(35-2) → 50-33 = 17\n💡 계산하기 쉬운 수로 바꾸는 마법이에요!",
        "🚀 분해곱셈 마스터: 큰 수를 10+α로 나누어 계산해요!\n예: 7×13 → 7×(10+3) → 7×10+7×3 → 70+21 = 91\n💡 큰 곱셈도 작은 곱셈 여러 개로 바뀌어요!"
      ],
      8: [
        "🎯 받아올림 마스터법: 일의 자리부터 10을 만들어요!\n예: 9+7 → 9+1+6 → 10+6 = 16\n💡 9에 1을 주고, 7에서 1을 빼면 10+6이 되어요!",
        "🎭 받아내림 없애기: 양쪽에서 같은 수를 더하거나 빼요!\n예: 52-35 → (52-2)-(35-2) → 50-33 = 17\n💡 계산하기 쉬운 수로 바꾸는 마법이에요!",
        "🚀 분해곱셈 마스터: 큰 수를 10+α로 나누어 계산해요!\n예: 7×13 → 7×(10+3) → 7×10+7×3 → 70+21 = 91\n💡 큰 곱셈도 작은 곱셈 여러 개로 바뀌어요!",
        "⭐ 9의 비밀: 9를 곱할 때는 10을 곱하고 자기 자신을 빼요!\n예: 8×9 → 8×10-8×1 → 80-8 = 72\n💡 9×표는 이렇게 하면 구구단을 몰라도 계산돼요!"
      ],
      9: [
        "🔄 분해덧셈 비법: 큰 수를 십의 자리와 일의 자리로 나누어요!\n예: 27+35 → (20+30)+(7+5) → 50+12 = 62\n💡 같은 자리끼리 따로 계산하면 실수가 줄어요!",
        "🔢 2배 활용법: 2배씩 계속 만들어 큰 곱셈을 해결해요!\n예: 6×8 → 6×2=12, 12×2=24, 24×2=48\n💡 2배→4배→8배 순서로 가면 어려운 곱셈도 쉬워요!",
        "🔄 곱셈표 역산법: 나눗셈은 곱셈의 반대! '몇 곱하기 몇이 이 수?'\n예: 56÷7 → 7×?=56 → 7×8=56 → 답: 8\n💡 구구단을 거꾸로 활용하는 가장 확실한 방법!"
      ],
      10: [
        "🔄 분해덧셈 비법: 큰 수를 십의 자리와 일의 자리로 나누어요!\n예: 27+35 → (20+30)+(7+5) → 50+12 = 62\n💡 같은 자리끼리 따로 계산하면 실수가 줄어요!",
        "🔢 2배 활용법: 2배씩 계속 만들어 큰 곱셈을 해결해요!\n예: 6×8 → 6×2=12, 12×2=24, 24×2=48\n💡 2배→4배→8배 순서로 가면 어려운 곱셈도 쉬워요!",
        "🔄 곱셈표 역산법: 나눗셈은 곱셈의 반대! '몇 곱하기 몇이 이 수?'\n예: 56÷7 → 7×?=56 → 7×8=56 → 답: 8\n💡 구구단을 거꾸로 활용하는 가장 확실한 방법!",
        "📦 분해나눗셈 비법: 나누어지는 수를 쪼개서 각각 나누어요!\n예: 84÷6 → (60+24)÷6 → 60÷6+24÷6 → 10+4 = 14\n💡 큰 수도 작은 단위로 나누면 쉬워져요!"
      ],
      11: [
        "🎯 양수곱셈 비법: 한쪽을 반으로, 다른 쪽을 2배로 만들어요!\n예: 8×15 → 4×30 → 2×60 → 1×120 = 120\n💡 계산하기 쉬운 형태로 바꾸는 고급 기법이에요!",
        "⚡ 추정나눗셈법: 대략적인 답을 먼저 추정하고 조정해요!\n예: 87÷3 → 90÷3=30이니까 조금 작겠다 → 29×3=87 → 답: 29\n💡 어림셈으로 답의 범위를 좁혀가는 프로 기법!",
        "🎭 괄호 우선 철칙: 계산 순서는 괄호→곱셈/나눗셈→덧셈/뺄셈!\n예: 3+4×5 → 3+20 = 23 (4×5를 먼저!)\n💡 순서를 지키지 않으면 완전히 다른 답이 나와요!"
      ],
      12: [
        "🎯 양수곱셈 비법: 한쪽을 반으로, 다른 쪽을 2배로 만들어요!\n예: 8×15 → 4×30 → 2×60 → 1×120 = 120\n💡 계산하기 쉬운 형태로 바꾸는 고급 기법이에요!",
        "⚡ 추정나눗셈법: 대략적인 답을 먼저 추정하고 조정해요!\n예: 87÷3 → 90÷3=30이니까 조금 작겠다 → 29×3=87 → 답: 29\n💡 어림셈으로 답의 범위를 좁혀가는 프로 기법!",
        "🎭 괄호 우선 철칙: 계산 순서는 괄호→곱셈/나눗셈→덧셈/뺄셈!\n예: 3+4×5 → 3+20 = 23 (4×5를 먼저!)\n💡 순서를 지키지 않으면 완전히 다른 답이 나와요!",
        "📝 단계별 정리법: 복잡한 식은 한 번에 하나씩만!\n예: (12+8)×(15-7) → 20×8 = 160\n💡 중간 과정을 옆에 적어가며 천천히 계산하세요!"
      ],
      13: [
        "🎯 양수곱셈 비법: 한쪽을 반으로, 다른 쪽을 2배로 만들어요!\n예: 8×15 → 4×30 → 2×60 → 1×120 = 120\n💡 계산하기 쉬운 형태로 바꾸는 고급 기법이에요!",
        "⚡ 추정나눗셈법: 대략적인 답을 먼저 추정하고 조정해요!\n예: 87÷3 → 90÷3=30이니까 조금 작겠다 → 29×3=87 → 답: 29\n💡 어림셈으로 답의 범위를 좁혀가는 프로 기법!",
        "🎭 괄호 우선 철칙: 계산 순서는 괄호→곱셈/나눗셈→덧셈/뺄셈!\n예: 3+4×5 → 3+20 = 23 (4×5를 먼저!)\n💡 순서를 지키지 않으면 완전히 다른 답이 나와요!",
        "🔍 어림셈 검증법: 계산 전에 대략적인 답을 예상해보세요!\n예: 23×19 → 대략 20×20=400 → 실제 답이 437이면 맞을 확률 높음\n💡 말도 안 되는 답이 나오면 계산 실수를 의심해보세요!",
        "🧩 분배법칙 활용: 괄호 밖의 수를 괄호 안 각각에 곱하거나 나누어요!\n예: 4×(15+8) → 4×15+4×8 → 60+32 = 92\n💡 복잡해 보이는 식도 간단한 계산 여러 개로 바뀌어요!"
      ]
    };

    // 오프닝 비디오 관련 요소들
    const openingContainer = document.getElementById('openingVideo');
    const gameContainer = document.getElementById('gameContainer');
    const skipButton = document.getElementById('skipButton');
    const openingVideoPlayer = document.getElementById('openingVideoPlayer');

    // 게임 화면 표시 함수
    function showGame() {
      openingContainer.style.display = 'none';
      gameContainer.style.display = 'flex';
      startBackgroundMusic();
    }

    // 오프닝 비디오 종료 시 자동으로 게임 시작
    openingVideoPlayer.addEventListener('ended', function() {
      console.log('비디오 재생 완료 - 게임 시작');
      showGame();
    });

    // 오프닝 비디오 로드 시 볼륨 설정
    openingVideoPlayer.addEventListener('loadedmetadata', function() {
      console.log('비디오 메타데이터 로드됨');
      openingVideoPlayer.volume = 1.0;
      openingVideoPlayer.muted = false;
    });

    // 오프닝 비디오 재생 시도
    openingVideoPlayer.addEventListener('loadstart', function() {
      console.log('비디오 로드 시작');
    });

    openingVideoPlayer.addEventListener('canplay', function() {
      console.log('비디오 재생 가능');
    });

    // 자동재생 시도
    function tryAutoplay() {
      openingVideoPlayer.play().then(() => {
        console.log('비디오 자동재생 성공');
      }).catch(e => {
        console.log('자동재생이 차단되었습니다:', e);
        // 자동재생이 차단된 경우 클릭하여 재생하도록 안내
        const playButton = document.createElement('button');
        playButton.textContent = '▶ 영상 재생하기';
        playButton.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          padding: 20px 40px;
          font-size: 20px;
          background: #66b5f6;
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          z-index: 1002;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        `;
        playButton.onclick = function() {
          openingVideoPlayer.play().then(() => {
            playButton.remove();
          }).catch(err => {
            console.log('수동 재생도 실패:', err);
            playButton.remove();
            showGame(); // 재생 실패 시 게임으로 넘어가기
          });
        };
        openingContainer.appendChild(playButton);
      });
    }

    // 오프닝 비디오 오류 시 게임 시작
    openingVideoPlayer.addEventListener('error', function(e) {
      console.log('비디오 재생 오류:', e);
      setTimeout(() => {
        showGame();
      }, 1000);
    });

    // 건너뛰기 버튼 클릭 시
    skipButton.addEventListener('click', function() {
      console.log('건너뛰기 버튼 클릭됨');
      openingVideoPlayer.pause();
      openingVideoPlayer.currentTime = 0;
      showGame();
    });

    // 비디오 파일이 없거나 로드되지 않을 경우 5초 후 게임 시작
    const videoTimeout = setTimeout(() => {
      if (openingContainer.style.display !== 'none') {
        console.log('비디오 로드 시간 초과 - 게임 시작');
        showGame();
      }
    }, 5000);

    // 비디오가 성공적으로 로드되면 타임아웃 취소
    openingVideoPlayer.addEventListener('loadeddata', function() {
      console.log('비디오 데이터 로드 완료');
      clearTimeout(videoTimeout);
    });

    // 축하 메시지 모달 관련
    const congratsModal = document.getElementById('congratsModal');
    const giftButton = document.getElementById('giftButton');
    const congratsSound = document.getElementById('congratsSound');
    const celebrationContainer = document.getElementById('celebrationVideo');
    const closeVideoBtn = document.getElementById('closeVideoBtn');
    const bgMusic = document.getElementById('bgMusic');

    // 게임 시작 시 배경음악 재생
    function startBackgroundMusic() {
      if (!bgMusicStarted) {
        bgMusic.volume = 0.4;
        bgMusic.play().catch(e => {
          console.log('배경음악 자동재생이 차단되었습니다. 사용자 상호작용 후 재생됩니다.');
        });
        bgMusicStarted = true;
      }
    }

    // 축하 메시지 표시 함수
    function showCongratsModal() {
      bgMusic.pause();
      congratsModal.style.display = 'flex';
      
      congratsSound.play().catch(e => {
        console.log('박수소리 재생 실패:', e);
      });
    }

    // 선물받기 버튼 클릭 이벤트
    giftButton.addEventListener('click', function() {
      congratsModal.style.display = 'none';
      playCelebrationVideo();
    });

    // 축하 영상 재생 함수
    function playCelebrationVideo() {
      const randomIndex = Math.floor(Math.random() * celebrationVideos.length);
      const videoId = celebrationVideos[randomIndex];
      
      const celebrationIframe = document.getElementById('celebrationPlayer');
      celebrationIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&controls=1&modestbranding=1&rel=0&enablejsapi=1`;
      
      celebrationContainer.style.display = 'flex';
    }

    // 축하 영상 닫기
    closeVideoBtn.addEventListener('click', function() {
      const celebrationIframe = document.getElementById('celebrationPlayer');
      celebrationIframe.src = '';
      celebrationContainer.style.display = 'none';
      bgMusic.play();
    });

    // 랜덤 함수
    function randInt(min, max) { 
      return Math.floor(Math.random() * (max - min + 1)) + min; 
    }

    // 나이별 문제 생성 함수 (기획서의 상세 커리큘럼 반영)
    function makeQuestions(age) {
      const arr = [];
      
      for (let i = 0; i < 20; i++) {
        let q = '', a = 0;
        
        if (age === 3) {
          // 3세: 1~5 이하 숫자만 (기획서 정확한 문제들)
          if (Math.random() < 0.5) {
            const problems = [
              [1,1,2], [1,2,3], [2,1,3], [2,2,4], [1,3,4], [3,1,4], [2,3,5], [3,2,5]
            ];
            const prob = problems[randInt(0, problems.length-1)];
            q = `${prob[0]} + ${prob[1]}`;
            a = prob[2];
          } else {
            const problems = [
              [2,1,1], [3,1,2], [3,2,1], [4,1,3], [4,2,2], [4,3,1], [5,1,4], [5,2,3], [5,3,2]
            ];
            const prob = problems[randInt(0, problems.length-1)];
            q = `${prob[0]} - ${prob[1]}`;
            a = prob[2];
          }
        } else if (age === 4) {
          // 4세: 1~5, 답이 5 이하 양수 (기획서 정확한 문제들)
          if (Math.random() < 0.5) {
            const problems = [
              [1,1], [1,2], [1,3], [1,4], [2,1], [2,2], [2,3], [3,1], [3,2], [4,1]
            ];
            const prob = problems[randInt(0, problems.length-1)];
            q = `${prob[0]} + ${prob[1]}`;
            a = prob[0] + prob[1];
          } else {
            const problems = [
              [2,1], [3,1], [3,2], [4,1], [4,2], [4,3], [5,1], [5,2], [5,3], [5,4]
            ];
            const prob = problems[randInt(0, problems.length-1)];
            q = `${prob[0]} - ${prob[1]}`;
            a = prob[0] - prob[1];
          }
        } else if (age >= 5 && age <= 6) {
          // 5-6세: 10 이하 한 자리 수
          if (Math.random() < 0.5) {
            const x = randInt(1, 9);
            const y = randInt(1, 10 - x);
            q = `${x} + ${y}`;
            a = x + y;
          } else {
            const x = randInt(1, 10);
            const y = randInt(1, x);
            q = `${x} - ${y}`;
            a = x - y;
          }
        } else if (age >= 7 && age <= 8) {
          // 7-8세: 받아올림/받아내림, 한 자리 곱셈
          const t = Math.random();
          if (t < 0.4) {
            // 받아올림 덧셈
            const pairs = [[9,2],[9,3],[9,4],[9,5],[9,6],[9,7],[9,8],[9,9],[8,3],[8,4],[8,5],[8,6],[8,7],[8,8],[8,9],[7,4],[7,5],[7,6],[7,7],[7,8],[7,9],[6,5],[6,6],[6,7],[6,8],[6,9]];
            const pair = pairs[randInt(0, pairs.length-1)];
            q = `${pair[0]} + ${pair[1]}`;
            a = pair[0] + pair[1];
          } else if (t < 0.7) {
            // 받아내림 뺄셈
            const pairs = [[12,3],[12,4],[12,5],[12,6],[12,7],[12,8],[12,9],[13,4],[13,5],[13,6],[13,7],[13,8],[13,9],[14,5],[14,6],[14,7],[14,8],[14,9],[15,6],[15,7],[15,8],[15,9],[16,7],[16,8],[16,9],[17,8],[17,9],[18,9]];
            const pair = pairs[randInt(0, pairs.length-1)];
            q = `${pair[0]} - ${pair[1]}`;
            a = pair[0] - pair[1];
          } else {
            // 한 자리 곱셈
            const pairs = [[2,2],[2,3],[2,4],[2,5],[3,3],[3,4],[3,5],[4,4],[4,5],[5,5],[2,6],[2,7],[2,8],[2,9],[3,6],[3,7],[3,8],[3,9],[4,6],[4,7]];
            const pair = pairs[randInt(0, pairs.length-1)];
            q = `${pair[0]} × ${pair[1]}`;
            a = pair[0] * pair[1];
          }
        } else if (age >= 9 && age <= 10) {
          // 9-10세: 두 자리 사칙연산, 구구단
          const t = Math.random();
          if (t < 0.25) {
            // 두 자리 덧셈
            const pairs = [[25,17],[34,28],[46,35],[57,24],[38,46],[29,33],[47,25],[56,38]];
            const pair = pairs[randInt(0, pairs.length-1)];
            q = `${pair[0]} + ${pair[1]}`;
            a = pair[0] + pair[1];
          } else if (t < 0.5) {
            // 두 자리 뺄셈
            const pairs = [[52,25],[63,37],[74,48],[85,59],[61,34],[72,45],[83,56],[94,67]];
            const pair = pairs[randInt(0, pairs.length-1)];
            q = `${pair[0]} - ${pair[1]}`;
            a = pair[0] - pair[1];
          } else if (t < 0.75) {
            // 구구단
            const pairs = [[6,7],[7,8],[8,9],[6,8],[7,9],[6,9],[7,7],[8,8],[9,9],[4,6],[4,7],[4,8],[4,9],[5,6],[5,7],[5,8],[5,9]];
            const pair = pairs[randInt(0, pairs.length-1)];
            q = `${pair[0]} × ${pair[1]}`;
            a = pair[0] * pair[1];
          } else {
            // 기본 나눗셈
            const problems = [[24,3],[24,4],[24,6],[24,8],[28,4],[28,7],[32,4],[32,8],[35,5],[35,7],[42,6],[42,7],[45,5],[45,9],[48,6],[48,8]];
            const prob = problems[randInt(0, problems.length-1)];
            q = `${prob[0]} ÷ ${prob[1]}`;
            a = prob[0] / prob[1];
          }
        } else {
          // 11-13세: 세 자리 수, 복합 계산
          const complex = Math.random() < 0.3;
          if (!complex) {
            const t = Math.random();
            if (t < 0.25) {
              // 세 자리 덧셈
              const pairs = [[156,278],[249,167],[378,245],[467,356],[189,234],[295,378],[346,289],[457,168]];
              const pair = pairs[randInt(0, pairs.length-1)];
              q = `${pair[0]} + ${pair[1]}`;
              a = pair[0] + pair[1];
            } else if (t < 0.5) {
              // 세 자리 뺄셈
              const pairs = [[456,189],[523,267],[634,278],[745,389],[512,145],[623,256],[734,367],[845,478]];
              const pair = pairs[randInt(0, pairs.length-1)];
              q = `${pair[0]} - ${pair[1]}`;
              a = pair[0] - pair[1];
            } else if (t < 0.75) {
              // 두 자리×한 자리
              const pairs = [[23,4],[34,5],[45,6],[56,7],[67,8],[78,9],[12,8],[13,9]];
              const pair = pairs[randInt(0, pairs.length-1)];
              q = `${pair[0]} × ${pair[1]}`;
              a = pair[0] * pair[1];
            } else {
              // 두 자리÷한 자리
              const problems = [[84,6],[96,8],[75,5],[91,7],[84,7],[88,4],[92,4],[87,3],[95,5]];
              const prob = problems[randInt(0, problems.length-1)];
              if (prob[0] % prob[1] === 0) {
                q = `${prob[0]} ÷ ${prob[1]}`;
                a = prob[0] / prob[1];
              } else {
                q = `${prob[0]} ÷ ${prob[1]}`;
                a = Math.floor(prob[0] / prob[1]);
              }
            }
          } else {
            // 복합계산
            const patterns = [
              [[12,25,3], (a,b,c) => `(${a} + ${b}) × ${c}`, (a,b,c) => (a+b)*c],
              [[4,18,7], (a,b,c) => `${a} × (${b} + ${c})`, (a,b,c) => a*(b+c)],
              [[145,67,35], (a,b,c) => `(${a} - ${b}) + ${c}`, (a,b,c) => (a-b)+c],
              [[28,4,6], (a,b,c) => `${a} + ${b} × ${c}`, (a,b,c) => a+(b*c)],
              [[5,16,23], (a,b,c) => `${a} × ${b} - ${c}`, (a,b,c) => (a*b)-c],
              [[72,6,19], (a,b,c) => `${a} ÷ ${b} + ${c}`, (a,b,c) => (a/b)+c]
            ];
            const pattern = patterns[randInt(0, patterns.length-1)];
            q = pattern[1](pattern[0][0], pattern[0][1], pattern[0][2]);
            a = pattern[2](pattern[0][0], pattern[0][1], pattern[0][2]);
          }
        }
        
        arr.push({q: q, a: a});
      }
      
      return arr.sort(() => Math.random() - 0.5);
    }

    // 결과 메시지 함수
    function getResultMsg(rate) {
      if (rate >= 90) return '우수해요! 수학천재! 👑🦖';
      if (rate >= 80) return '조금만 더 하면 90%도 가능해요! 화이팅! 🌈';
      return '70%가 넘을 때까지 조금 더 연습해요! 재도전 Go! 🚍👑';
    }

    // 게임 시작
    document.getElementById('startQuizBtn').onclick = function() {
      const age = parseInt(document.getElementById('ageSelect').value);
      if (!age || age < 3 || age > 13) { 
        alert('3~13세 나이만 선택 가능합니다!'); 
        return; 
      }
      
      quiz.age = age;
      quiz.questions = makeQuestions(age);
      quiz.current = 0;
      quiz.correct = 0;
      quiz.consecutiveCorrect = 0;
      quiz.consecutiveWrong = 0;
      
      document.getElementById('ageSection').style.display = 'none';
      document.getElementById('quizSection').style.display = 'block';
      document.getElementById('resultSection').style.display = 'none';
      showQuestion();
      
      // 배경음악 시작
      startBackgroundMusic();
    };

    // 문제 표시
    function showQuestion() {
      const qinfo = quiz.questions[quiz.current];
      document.getElementById('questionNum').textContent = `문제 ${quiz.current + 1} / 20`;
      document.getElementById('questionText').textContent = qinfo.q + ' = ?';
      document.getElementById('answerInput').value = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('mathTip').style.display = 'none';
      document.getElementById('answerInput').focus();
      document.getElementById('submitAnswerBtn').textContent = '정답 확인';
      document.getElementById('submitAnswerBtn').disabled = false;
      // 버튼 기능을 정답 확인으로 복원
      document.getElementById('submitAnswerBtn').onclick = checkAnswer;
    }

    // 정답 확인 함수
    function checkAnswer() {
      const userAns = document.getElementById('answerInput').value.trim();
      const q = quiz.questions[quiz.current];
      
      if (userAns === "") { 
        document.getElementById('feedback').textContent = "답을 입력해 주세요!"; 
        return; 
      }
      
      if (Number(userAns) === q.a) {
        // 정답 처리
        quiz.correct++;
        quiz.consecutiveCorrect++;
        quiz.consecutiveWrong = 0;
        
        let message;
        if (quiz.consecutiveCorrect >= 3) {
          message = consecutiveMessages[randInt(0, consecutiveMessages.length - 1)];
        } else if (q.a > 50 || (quiz.age >= 11 && q.q.includes('×') && q.a > 100)) {
          message = hardCorrectMessages[randInt(0, hardCorrectMessages.length - 1)];
        } else {
          message = correctMessages[randInt(0, correctMessages.length - 1)];
        }
        
        document.getElementById('feedback').textContent = message;
        document.getElementById('feedback').style.color = '#28a745';
        
        // 효과음 재생
        if (!applauseCooldown) {
          const applauseSound = document.getElementById('applauseSound');
          applauseSound.currentTime = 0;
          applauseSound.play().catch(e => {
            console.log('효과음 재생 실패:', e);
          });
          applauseCooldown = true;
          setTimeout(() => { applauseCooldown = false; }, 1500);
        }
        
        // 정답 시 1.2초 후 자동으로 다음 문제
        document.getElementById('submitAnswerBtn').textContent = '다음 문제';
        document.getElementById('submitAnswerBtn').disabled = true;
        
        setTimeout(() => {
          goToNextQuestion();
        }, 1200);
        
      } else {
        // 오답 처리
        quiz.consecutiveCorrect = 0;
        quiz.consecutiveWrong++;
        
        let message;
        if (quiz.consecutiveWrong >= 3) {
          message = consecutiveWrongMessages[randInt(0, consecutiveWrongMessages.length - 1)];
        } else {
          message = wrongMessages[randInt(0, wrongMessages.length - 1)];
        }
        
        document.getElementById('feedback').textContent = `${message} (정답: ${q.a})`;
        document.getElementById('feedback').style.color = '#dc3545';
        
        // 수학 팁 표시
        const tips = mathTips[quiz.age] || [];
        if (tips.length > 0) {
          const randomTip = tips[randInt(0, tips.length - 1)];
          document.getElementById('mathTip').innerHTML = randomTip.replace(/\n/g, '<br>');
          document.getElementById('mathTip').style.display = 'block';
        }
        
        // 오답 시 수동으로 다음 문제로 (자동 넘어가기 제거)
        document.getElementById('submitAnswerBtn').textContent = '다음 문제';
        document.getElementById('submitAnswerBtn').disabled = false;
        document.getElementById('submitAnswerBtn').onclick = goToNextQuestion;
      }
    }

    // 다음 문제로 이동하는 함수
    function goToNextQuestion() {
      quiz.current++;
      if (quiz.current >= 20) {
        finishQuiz();
      } else {
        showQuestion();
      }
    }

    // 정답 확인 버튼 이벤트
    document.getElementById('submitAnswerBtn').onclick = checkAnswer;

    // 엔터키 처리
    document.getElementById('answerInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const btn = document.getElementById('submitAnswerBtn');
        if (!btn.disabled) {
          btn.click();
        }
      }
    });

    // 퀴즈 완료
    function finishQuiz() {
      document.getElementById('quizSection').style.display = 'none';
      document.getElementById('resultSection').style.display = 'block';
      document.getElementById('correctCount').textContent = quiz.correct;
      document.getElementById('totalCount').textContent = '20';
      
      const rate = Math.round(quiz.correct / 20 * 100);
      document.getElementById('accuracy').textContent = rate;
      document.getElementById('resultMsg').textContent = getResultMsg(rate);
      document.getElementById('retryBtn').style.display = (rate < 70) ? 'inline-block' : 'none';
      
      // 90점 이상이면 2초 후 축하 메시지 모달 표시
      if (rate >= 90) {
        setTimeout(() => {
          showCongratsModal();
        }, 2000);
      }
    }

    // 재도전
    document.getElementById('retryBtn').onclick = function() {
      quiz.current = 0;
      quiz.correct = 0;
      quiz.consecutiveCorrect = 0;
      quiz.consecutiveWrong = 0;
      quiz.questions = makeQuestions(quiz.age);
      
      document.getElementById('ageSection').style.display = 'none';
      document.getElementById('quizSection').style.display = 'block';
      document.getElementById('resultSection').style.display = 'none';
      showQuestion();
    };

    // 처음으로
    document.getElementById('restartBtn').onclick = function() {
      location.reload();
    };

    // 음소거 토글
    document.getElementById('muteBtn').onclick = function() {
      isSoundOn = !isSoundOn;
      bgMusic.muted = !isSoundOn;
      this.textContent = isSoundOn ? '🔊' : '🔇';
    };

    // 페이지 로드 시 오프닝 비디오부터 시작
    window.addEventListener('load', function() {
      console.log('페이지 로드 완료 - 오프닝 비디오 시작');
      // 오프닝 비디오가 먼저 표시됨
      openingContainer.style.display = 'flex';
      gameContainer.style.display = 'none';
      
      // 페이지 로드 후 자동재생 시도
      setTimeout(() => {
        tryAutoplay();
      }, 500);
    });

  </script>
</body>
</html>
