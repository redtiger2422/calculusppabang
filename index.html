<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>타요 & 티니핑 수학 모험</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(120deg, #a1e0ff 40%, #f9e0ff 100%);
      box-sizing: border-box;
      font-family: 'Spoqa Han Sans Neo', 'Noto Sans KR', Arial, sans-serif;
    }
    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    #openingVideo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #openingVideo video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    #openingVideoPlayer {
      width: 100%;
      height: 100%;
      max-width: 1280px;
      max-height: 720px;
    }
    
    #skipButton {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.8);
      color: #333;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      z-index: 1001;
      transition: background 0.3s;
    }
    
    #skipButton:hover {
      background: rgba(255, 255, 255, 0.95);
    }
    
    #soundButton {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(102, 181, 246, 0.9);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      z-index: 1001;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    #soundButton:hover {
      background: rgba(61, 151, 224, 0.95);
      transform: translateX(-50%) scale(1.05);
    }
    
    /* 축하 메시지 모달 스타일 */
    #congratsModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    
    #congratsBox {
      background: linear-gradient(135deg, #fff 0%, #ffd6f3 100%);
      border-radius: 25px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
      animation: bounceIn 0.6s ease-out;
      max-width: 90%;
      width: 450px;
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    #congratsMessage {
      font-size: 26px;
      font-weight: bold;
      color: #ff1493;
      margin-bottom: 30px;
      line-height: 1.5;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    #giftButton {
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: white;
      font-size: 20px;
      font-weight: bold;
      padding: 15px 40px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #giftButton:hover {
      background: linear-gradient(45deg, #ff5252, #ff7043);
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(255, 107, 107, 0.6);
    }
    
    .gift-emoji {
      font-size: 50px;
      margin: 20px 0;
      animation: rotate 3s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* 축하 비디오 스타일 */
    #celebrationVideo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #celebrationPlayer {
      width: 100%;
      height: 100%;
      max-width: 1280px;
      max-height: 720px;
    }
    
    .celebration-text {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #FFD700;
      font-size: 28px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      animation: sparkle 1.5s ease-in-out infinite;
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    #closeVideoBtn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 100, 100, 0.9);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      z-index: 1001;
      transition: all 0.3s;
    }
    
    #closeVideoBtn:hover {
      background: rgba(255, 50, 50, 0.95);
      transform: translateX(-50%) scale(1.05);
    }
    
    #gameContainer {
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    #gameBox {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      box-shadow: 0 6px 40px rgba(20,60,160,0.17);
      padding: 32px 24px 20px 24px;
      max-width: 420px;
      min-width: 330px;
      width: 90vw;
      margin: 0 auto;
      position: relative;
      text-align: center;
    }
    #logoImages {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 10px;
      margin-bottom: 12px;
    }
    .logo-char {
      height: 60px;
      border-radius: 10px;
      object-fit: contain;
      box-shadow: 0 3px 15px rgba(30,70,180,0.11);
      background: #eaf6ff;
      padding: 3px;
    }
    #adventureMsg {
      margin-bottom: 12px;
    }
    #adventureMsg div {
      color: #3186eb;
      font-size: 1.32em;
      font-weight: bold;
      letter-spacing: 1px;
      text-shadow: 0 1px 5px #fff6;
      animation: bounce 2.2s infinite;
      margin: 4px 0;
    }
    @keyframes bounce {
      0% { transform: translateY(0); }
      15% { transform: translateY(-6px); }
      30% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
      70% { transform: translateY(0); }
    }
    label, select, button, input {
      font-size: 1.15em;
    }
    select, input {
      padding: 7px 12px;
      border-radius: 6px;
      border: 1.2px solid #aad3fd;
      margin-bottom: 12px;
      width: 70%;
      max-width: 200px;
      background: #f5fbff;
    }
    button {
      margin-top: 5px;
      background: #66b5f6;
      color: white;
      font-weight: bold;
      padding: 8px 24px;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      box-shadow: 0 2px 7px #88c6fc55;
      transition: background 0.2s;
    }
    button:hover { background: #3d97e0; }
    #questionNum {
      font-size: 1.07em;
      color: #9791cf;
      margin-bottom: 5px;
    }
    #questionText {
      font-size: 1.6em;
      font-weight: bold;
      color: #3677b6;
      margin-bottom: 18px;
      margin-top: 0;
    }
    #answerInput {
      text-align: center;
      font-weight: bold;
      letter-spacing: 1px;
    }
    #feedback {
      min-height: 1.1em;
      font-size: 1.13em;
      font-weight: 500;
      margin: 7px 0 0 0;
      color: #fa7e2e;
    }
    #mathTip {
      background: linear-gradient(135deg, #e3f2fd 0%, #f8e8ff 100%);
      border-left: 4px solid #3186eb;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      text-align: left;
      font-size: 0.95em;
      color: #3677b6;
      display: none;
      line-height: 1.4;
    }
    #resultSection {
      margin: 0 0 10px 0;
    }
    #resultSection h2 {
      color: #3a7fbc;
      margin-bottom: 5px;
    }
    #resultMsg {
      font-size: 1.14em;
      margin: 12px 0 8px 0;
      color: #6864e2;
    }
    #madeBy {
      font-size: 0.99em;
      color: #aaa;
      margin-top: 18px;
      letter-spacing: 1.5px;
      text-align: center;
      width: 100%;
      position: relative;
    }
    #muteBtn {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.45em;
      cursor: pointer;
      z-index: 99;
      color: #3186eb;
      user-select: none;
      padding: 0;
    }
    @media (max-width: 500px) {
      #gameBox {
        min-width: unset;
        padding: 8vw 2vw 5vw 2vw;
      }
      .logo-char {
        height: 44px;
      }
      #muteBtn {
        right: 10px;
        top: 8px;
      }
      #skipButton {
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        font-size: 12px;
      }
      #soundButton, #closeVideoBtn {
        bottom: 10px;
        padding: 10px 20px;
        font-size: 14px;
      }
      .celebration-text {
        font-size: 20px;
      }
      #congratsBox {
        padding: 30px;
        width: 90%;
      }
      #congratsMessage {
        font-size: 20px;
      }
      #giftButton {
        font-size: 16px;
        padding: 12px 30px;
      }
      .gift-emoji {
        font-size: 40px;
      }
      #mathTip {
        font-size: 0.9em;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- 오프닝 비디오 섹션 -->
  <div id="openingVideo">
    <video id="openingVideoPlayer" autoplay>
      <source src="openvd.mp4" type="video/mp4">
      브라우저가 비디오를 지원하지 않습니다.
    </video>
    <button id="skipButton">건너뛰기</button>
  </div>

  <!-- 게임 컨테이너 -->
  <div id="gameContainer" style="display: none;">
    <div id="gameBox">
      <button id="muteBtn" title="음소거 전환">🔊</button>
      <div id="logoImages">
        <img src="티니핑공주.png" alt="티니핑공주" class="logo-char" onerror="this.style.display='none'">
        <img src="타요자동차.png" alt="타요자동차" class="logo-char" onerror="this.style.display='none'">
      </div>
      <div id="adventureMsg">
        <div>💡 신나는 타요와 티니핑의 수학 모험!💡</div>
        <div>🚘 지금 떠나요! 🚘</div>
      </div>
      <!-- 나이 선택 화면 -->
      <div id="ageSection">
        <label for="ageSelect">나이를 선택하세요 (3세~13세):</label><br>
        <select id="ageSelect">
          <option value="">-- 나이 선택 --</option>
          <option value="3">3세</option>
          <option value="4">4세</option>
          <option value="5">5세</option><option value="6">6세</option><option value="7">7세</option>
          <option value="8">8세</option><option value="9">9세</option><option value="10">10세</option>
          <option value="11">11세</option><option value="12">12세</option><option value="13">13세</option>
        </select>
        <br><button id="startQuizBtn">모험 시작!</button>
      </div>
      <!-- 문제 퀴즈 화면 -->
      <div id="quizSection" style="display:none;">
        <div id="questionNum"></div>
        <div id="questionText"></div>
        <input id="answerInput" type="text" autocomplete="off" placeholder="정답을 써주세요!">
        <br><button id="submitAnswerBtn">정답 확인</button>
        <div id="feedback"></div>
        <div id="mathTip"></div>
      </div>
      <!-- 결과 화면 -->
      <div id="resultSection" style="display:none;">
        <h2>🎉 모험 완료! 🎉</h2>
        <div>맞춘 개수: <span id="correctCount"></span> / <span id="totalCount"></span></div>
        <div>정답률: <span id="accuracy"></span>%</div>
        <div id="resultMsg"></div>
        <button id="retryBtn" style="display:none;">재도전하기</button>
        <button id="restartBtn">처음으로</button>
      </div>
      <div id="madeBy">Made by 적호약사</div>
    </div>
  </div>

  <!-- 축하 메시지 모달 -->
  <div id="congratsModal">
    <div id="congratsBox">
      <div class="gift-emoji">🎁</div>
      <div id="congratsMessage">
        와우! 수학 천재이신가요!?<br>
        축하 선물을 드리겠습니다~!!
      </div>
      <button id="giftButton">선물받기</button>
    </div>
  </div>

  <!-- 축하 비디오 섹션 -->
  <div id="celebrationVideo">
    <div class="celebration-text">🎉 축하합니다! 90점 이상! 🎉</div>
    <iframe id="celebrationPlayer" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen>
    </iframe>
    <button id="closeVideoBtn">게임으로 돌아가기</button>
  </div>

  <!-- 배경 음악, 효과음 -->
  <audio id="bgMusic" src="tayo1.mp3" loop></audio>
  <audio id="applauseSound" src="coin.mp3" preload="auto"></audio>
  <audio id="congratsSound" src="박수소리1.mp3" preload="auto"></audio>

  <script>
    let quiz = { age: null, questions: [], current: 0, correct: 0, consecutiveCorrect: 0, consecutiveWrong: 0 };
    let applauseCooldown = false;
    let bgMusicStarted = false;
    let isSoundOn = true;

    // 축하 영상 목록
    const celebrationVideos = [
      'yg9vV3_rVI0',
      '5chNiLy9X_A',
      'vE7tGIxzfwo',
      'HbBNNzHVLlA'
    ];

    // 정답 시 축하 메시지 (기획서 반영)
    const correctMessages = [
      "정답! 완전 천재 아니야? 🚍",
      "맞았어요! 혹시... 혹시 멘사신가요? 👑", 
      "대박! 수학 신동 등장! 🌟",
      "우와! 진짜 똑똑하다! 💎",
      "완벽해! 수학 마법사세요? ✨",
      "쩐다! 타요도 깜짝 놀랐어요! 🚌",
      "헐~ 진짜 대단한데요? 🔥",
      "와우! 이 정도면 수학 천재! 🧠",
      "멋져요! 티니핑도 박수쳐요! 👑",
      "정답! 혹시 미래의 수학자? 🎯",
      "짱이에요! 완전 수학 고수! ⭐",
      "오마이갓! 이런 실력이! 😍",
      "대단해! 어른도 못 푸는데? 💪",
      "와~ 진짜 머리 좋으시네요! 🎊",
      "정답! 수학계의 신성! 🌈",
      "크으~ 이 정도 실력이면! 🎈",
      "놀라워! 진짜 수학 영재! 🎨",
      "맞혔다! 혹시 수학 선생님? 📚",
      "쌩큐! 완전 깔끔한 정답! 🎪",
      "정말 굿! 수학 마스터! 🏆"
    ];

    // 연속 정답 시 특별 메시지
    const consecutiveMessages = [
      "연속 정답! 진짜 롤모델이세요! 🔥",
      "계속 맞히네! 수학의 신 강림! ⚡",
      "와! 연타! 이건 진짜 실력! 💥",
      "스트라이크! 무시무시한 실력! 🎯"
    ];

    // 어려운 문제 정답 시
    const hardCorrectMessages = [
      "이런 어려운 것도! 진짜 대박! 🚀",
      "헉! 이걸 맞히다니! 완전 천재! 🌟",
      "와우! 이 문제는 정말 어려운데! 🏅"
    ];

    // 오답 시 격려 메시지 (기획서 반영)
    const wrongMessages = [
      "괜찮아요! 틀리는 게 더 많이 배우는 거예요! 💪",
      "실수는 성장의 계단이에요! 다음엔 더 잘할 거예요! 🌱",
      "아쉽! 하지만 포기는 금물! 화이팅! 🔥",
      "오답도 소중한 경험! 조금만 더 생각해봐요! 🤔",
      "틀려도 괜찮아요! 배우는 과정이니까요! 📚",
      "아깝다! 조금만 더 집중하면 될 것 같은데! 👀",
      "실수는 누구나 해요! 중요한 건 다시 도전하는 거! 🚀",
      "괜찮아요! 천천히 하나씩 배워가요! 🐢",
      "틀렸지만 그래도 열심히 했어요! 👏",
      "아쉽지만 다음 문제에서 만회하자! 💫",
      "실패는 성공의 어머니! 다시 힘내요! 🌈",
      "괜찮아요! 모르는 걸 알게 된 거잖아요! 💡",
      "오답! 하지만 배움의 기회! 🎯",
      "틀려도 OK! 중요한 건 끝까지 하는 거! 🏃‍♂️",
      "아쉽! 하지만 점점 늘고 있어요! 📈"
    ];

    // 연속 오답 시 특별 격려
    const consecutiveWrongMessages = [
      "괜찮아요! 어려운 문제가 계속 나왔네요! 😊",
      "조금 어렵죠? 천천히 해봐요! 🕰️",
      "힘들어도 포기하지 마세요! 거의 다 왔어요! 🎈"
    ];

    // 랜덤 함수
    function randInt(min, max) { 
      return Math.floor(Math.random() * (max - min + 1)) + min; 
    }

    // 배열 셔플 함수
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // 나이별 문제 풀 생성 함수 (중복 방지)
    function generateQuestionPool(age) {
      const pool = [];
      
      if (age === 3) {
        // 3세: 1~5 이하 숫자만 - 정확한 문제들
        const addProblems = [
          [1,1], [1,2], [2,1], [2,2], [1,3], [3,1], [2,3], [3,2], [1,4], [4,1]
        ];
        const subProblems = [
          [2,1], [3,1], [3,2], [4,1], [4,2], [4,3], [5,1], [5,2], [5,3], [5,4]
        ];
        
        addProblems.forEach(([a, b]) => {
          pool.push({q: `${a} + ${b}`, a: a + b});
        });
        
        subProblems.forEach(([a, b]) => {
          pool.push({q: `${a} - ${b}`, a: a - b});
        });
        
      } else if (age === 4) {
        // 4세: 1~5, 답이 5 이하 양수
        const addProblems = [
          [1,1], [1,2], [1,3], [1,4], [2,1], [2,2], [2,3], [3,1], [3,2], [4,1], [2,4], [4,2], [3,3]
        ];
        const subProblems = [
          [2,1], [3,1], [3,2], [4,1], [4,2], [4,3], [5,1], [5,2], [5,3], [5,4], [5,5]
        ];
        
        addProblems.forEach(([a, b]) => {
          if (a + b <= 5) {
            pool.push({q: `${a} + ${b}`, a: a + b});
          }
        });
        
        subProblems.forEach(([a, b]) => {
          pool.push({q: `${a} - ${b}`, a: a - b});
        });
        
      } else if (age >= 5 && age <= 6) {
        // 5-6세: 10 이하 한 자리 수
        for (let x = 1; x <= 9; x++) {
          for (let y = 1; y <= 10 - x; y++) {
            pool.push({q: `${x} + ${y}`, a: x + y});
          }
        }
        
        for (let x = 1; x <= 10; x++) {
          for (let y = 1; y <= x; y++) {
            pool.push({q: `${x} - ${y}`, a: x - y});
          }
        }
        
      } else if (age >= 7 && age <= 8) {
        // 7-8세: 받아올림/받아내림, 한 자리 곱셈
        
        // 받아올림 덧셈
        const carryAddPairs = [
          [9,2],[9,3],[9,4],[9,5],[9,6],[9,7],[9,8],[9,9],
          [8,3],[8,4],[8,5],[8,6],[8,7],[8,8],[8,9],
          [7,4],[7,5],[7,6],[7,7],[7,8],[7,9],
          [6,5],[6,6],[6,7],[6,8],[6,9],
          [5,6],[5,7],[5,8],[5,9],
          [4,7],[4,8],[4,9],
          [3,8],[3,9],
          [2,9]
        ];
        
        carryAddPairs.forEach(([a, b]) => {
          pool.push({q: `${a} + ${b}`, a: a + b});
        });
        
        // 받아내림 뺄셈
        const borrowSubPairs = [
          [12,3],[12,4],[12,5],[12,6],[12,7],[12,8],[12,9],
          [13,4],[13,5],[13,6],[13,7],[13,8],[13,9],
          [14,5],[14,6],[14,7],[14,8],[14,9],
          [15,6],[15,7],[15,8],[15,9],
          [16,7],[16,8],[16,9],
          [17,8],[17,9],
          [18,9]
        ];
        
        borrowSubPairs.forEach(([a, b]) => {
          pool.push({q: `${a} - ${b}`, a: a - b});
        });
        
        // 한 자리 곱셈
        const multiplyPairs = [
          [2,2],[2,3],[2,4],[2,5],[2,6],[2,7],[2,8],[2,9],
          [3,3],[3,4],[3,5],[3,6],[3,7],[3,8],[3,9],
          [4,4],[4,5],[4,6],[4,7],[4,8],[4,9],
          [5,5],[5,6],[5,7],[5,8],[5,9],
          [6,6],[6,7],[6,8],[6,9],
          [7,7],[7,8],[7,9],
          [8,8],[8,9],
          [9,9]
        ];
        
        multiplyPairs.forEach(([a, b]) => {
          pool.push({q: `${a} × ${b}`, a: a * b});
        });
        
      } else if (age >= 9 && age <= 10) {
        // 9-10세: 두 자리 사칙연산, 구구단
        
        // 두 자리 덧셈
        const twoDigitAdd = [
          [25,17],[34,28],[46,35],[57,24],[38,46],[29,33],[47,25],[56,38],
          [23,19],[35,27],[48,36],[59,25],[37,44],[28,35],[49,26],[58,37],
          [26,18],[33,29],[45,37],[54,28],[39,43],[27,34],[44,29],[55,36]
        ];
        
        twoDigitAdd.forEach(([a, b]) => {
          pool.push({q: `${a} + ${b}`, a: a + b});
        });
        
        // 두 자리 뺄셈
        const twoDigitSub = [
          [52,25],[63,37],[74,48],[85,59],[61,34],[72,45],[83,56],[94,67],
          [53,26],[64,38],[75,49],[86,58],[62,35],[73,46],[84,57],[95,68],
          [54,27],[65,39],[76,47],[87,56],[63,36],[74,47],[85,58],[96,69]
        ];
        
        twoDigitSub.forEach(([a, b]) => {
          pool.push({q: `${a} - ${b}`, a: a - b});
        });
        
        // 구구단
        const multiplication = [
          [6,7],[7,8],[8,9],[6,8],[7,9],[6,9],[7,7],[8,8],[9,9],
          [4,6],[4,7],[4,8],[4,9],[5,6],[5,7],[5,8],[5,9],
          [3,6],[3,7],[3,8],[3,9],[2,6],[2,7],[2,8],[2,9]
        ];
        
        multiplication.forEach(([a, b]) => {
          pool.push({q: `${a} × ${b}`, a: a * b});
        });
        
        // 기본 나눗셈
        const division = [
          [24,3],[24,4],[24,6],[24,8],[28,4],[28,7],[32,4],[32,8],
          [35,5],[35,7],[42,6],[42,7],[45,5],[45,9],[48,6],[48,8],
          [36,6],[36,9],[40,5],[40,8],[54,6],[54,9],[56,7],[56,8]
        ];
        
        division.forEach(([a, b]) => {
          pool.push({q: `${a} ÷ ${b}`, a: a / b});
        });
        
      } else {
        // 11-13세: 세 자리 수, 복합 계산
        
        // 세 자리 덧셈
        const threeDigitAdd = [
          [156,278],[249,167],[378,245],[467,356],[189,234],[295,378],[346,289],[457,168],
          [234,189],[345,267],[456,378],[567,234],[178,345],[289,456],[356,234],[467,178]
        ];
        
        threeDigitAdd.forEach(([a, b]) => {
          pool.push({q: `${a} + ${b}`, a: a + b});
        });
        
        // 세 자리 뺄셈
        const threeDigitSub = [
          [456,189],[523,267],[634,278],[745,389],[512,145],[623,256],[734,367],[845,478],
          [567,234],[678,345],[789,456],[654,287],[765,398],[876,234],[543,176],[632,245]
        ];
        
        threeDigitSub.forEach(([a, b]) => {
          pool.push({q: `${a} - ${b}`, a: a - b});
        });
        
        // 두 자리×한 자리
        const twoByOne = [
          [23,4],[34,5],[45,6],[56,7],[67,8],[78,9],[12,8],[13,9],
          [24,5],[35,6],[46,7],[57,8],[68,9],[79,4],[21,7],[32,8]
        ];
        
        twoByOne.forEach(([a, b]) => {
          pool.push({q: `${a} × ${b}`, a: a * b});
        });
        
        // 두 자리÷한 자리
        const twoByOneDiv = [
          [84,6],[96,8],[75,5],[91,7],[88,4],[92,4],[87,3],[95,5],
          [72,6],[81,9],[64,8],[56,7],[48,6],[63,9],[54,6],[42,7]
        ];
        
        twoByOneDiv.forEach(([a, b]) => {
          if (a % b === 0) {
            pool.push({q: `${a} ÷ ${b}`, a: a / b});
          }
        });
        
        // 복합계산
        const complexProblems = [
          {q: '(12 + 25) × 3', a: (12 + 25) * 3},
          {q: '4 × (18 + 7)', a: 4 * (18 + 7)},
          {q: '(145 - 67) + 35', a: (145 - 67) + 35},
          {q: '28 + 4 × 6', a: 28 + 4 * 6},
          {q: '5 × 16 - 23', a: 5 * 16 - 23},
          {q: '72 ÷ 6 + 19', a: 72 / 6 + 19},
          {q: '(23 + 17) × 2', a: (23 + 17) * 2},
          {q: '6 × (15 + 9)', a: 6 * (15 + 9)},
          {q: '(234 - 89) + 56', a: (234 - 89) + 56},
          {q: '36 + 7 × 8', a: 36 + 7 * 8},
          {q: '9 × 12 - 34', a: 9 * 12 - 34},
          {q: '84 ÷ 7 + 25', a: 84 / 7 + 25}
        ];
        
        complexProblems.forEach(problem => {
          pool.push(problem);
        });
      }
      
      return pool;
    }

    // 나이별 문제 생성 함수 (완전 중복 방지)
    function makeQuestions(age) {
      const pool = generateQuestionPool(age);
      
      // 중복 제거: 문제 텍스트를 기준으로 중복 제거
      const uniquePool = [];
      const seenQuestions = new Set();
      
      for (const problem of pool) {
        if (!seenQuestions.has(problem.q)) {
          seenQuestions.add(problem.q);
          uniquePool.push(problem);
        }
      }
      
      console.log(`나이 ${age}세: 총 ${uniquePool.length}개의 고유 문제 생성`);
      
      // 충분한 문제가 없으면 추가 생성
      if (uniquePool.length < 20) {
        console.log(`문제 부족 (${uniquePool.length}개) - 추가 생성 중...`);
        const additionalProblems = generateAdditionalQuestions(age, 20 - uniquePool.length, seenQuestions);
        uniquePool.push(...additionalProblems);
      }
      
      // 섞기
      const shuffled = shuffleArray(uniquePool);
      
      // 정확히 20개 선택 (중복 없음 보장)
      const selected = shuffled.slice(0, 20);
      
      // 최종 중복 검사 (안전장치)
      const finalCheck = new Set();
      const finalQuestions = [];
      
      for (const problem of selected) {
        if (!finalCheck.has(problem.q)) {
          finalCheck.add(problem.q);
          finalQuestions.push(problem);
        }
      }
      
      console.log(`최종 선택된 문제: ${finalQuestions.length}개 (중복 없음)`);
      
      return finalQuestions;
    }

    // 추가 문제 생성 함수 (부족한 경우)
    function generateAdditionalQuestions(age, needed, existingQuestions) {
      const additional = [];
      let attempts = 0;
      const maxAttempts = 1000; // 무한루프 방지
      
      while (additional.length < needed && attempts < maxAttempts) {
        attempts++;
        let q = '', a = 0;
        
        // 나이별 추가 문제 생성 로직
        if (age === 3) {
          if (Math.random() < 0.5) {
            const x = randInt(1, 3);
            const y = randInt(1, 5 - x);
            q = `${x} + ${y}`;
            a = x + y;
          } else {
            const x = randInt(2, 5);
            const y = randInt(1, x - 1);
            q = `${x} - ${y}`;
            a = x - y;
          }
        } else if (age === 4) {
          if (Math.random() < 0.5) {
            const x = randInt(1, 4);
            const y = randInt(1, 5 - x);
            q = `${x} + ${y}`;
            a = x + y;
          } else {
            const x = randInt(2, 5);
            const y = randInt(1, x);
            q = `${x} - ${y}`;
            a = x - y;
          }
        } else if (age >= 5 && age <= 6) {
          if (Math.random() < 0.5) {
            const x = randInt(1, 9);
            const y = randInt(1, 10 - x);
            q = `${x} + ${y}`;
            a = x + y;
          } else {
            const x = randInt(2, 10);
            const y = randInt(1, x);
            q = `${x} - ${y}`;
            a = x - y;
          }
        } else if (age >= 7 && age <= 8) {
          const t = Math.random();
          if (t < 0.4) {
            // 받아올림 덧셈
            const x = randInt(6, 9);
            const y = randInt(10 - x + 1, 9);
            q = `${x} + ${y}`;
            a = x + y;
          } else if (t < 0.7) {
            // 받아내림 뺄셈
            const x = randInt(11, 18);
            const y = randInt(Math.max(2, x - 10), Math.min(9, x - 1));
            q = `${x} - ${y}`;
            a = x - y;
          } else {
            // 곱셈
            const x = randInt(2, 9);
            const y = randInt(2, 9);
            q = `${x} × ${y}`;
            a = x * y;
          }
        } else if (age >= 9 && age <= 10) {
          const t = Math.random();
          if (t < 0.25) {
            // 두 자리 덧셈
            const x = randInt(12, 89);
            const y = randInt(12, 89);
            q = `${x} + ${y}`;
            a = x + y;
          } else if (t < 0.5) {
            // 두 자리 뺄셈
            const x = randInt(25, 99);
            const y = randInt(12, x - 1);
            q = `${x} - ${y}`;
            a = x - y;
          } else if (t < 0.75) {
            // 구구단
            const x = randInt(2, 9);
            const y = randInt(2, 9);
            q = `${x} × ${y}`;
            a = x * y;
          } else {
            // 나눗셈
            const y = randInt(2, 9);
            const result = randInt(2, 12);
            const x = y * result;
            q = `${x} ÷ ${y}`;
            a = result;
          }
        } else {
          // 11-13세
          const t = Math.random();
          if (t < 0.2) {
            // 세 자리 덧셈
            const x = randInt(100, 899);
            const y = randInt(100, 899);
            q = `${x} + ${y}`;
            a = x + y;
          } else if (t < 0.4) {
            // 세 자리 뺄셈
            const x = randInt(200, 999);
            const y = randInt(100, x - 1);
            q = `${x} - ${y}`;
            a = x - y;
          } else if (t < 0.6) {
            // 두 자리×한 자리
            const x = randInt(12, 99);
            const y = randInt(2, 9);
            q = `${x} × ${y}`;
            a = x * y;
          } else if (t < 0.8) {
            // 두 자리÷한 자리
            const y = randInt(2, 9);
            const result = randInt(5, 15);
            const x = y * result;
            q = `${x} ÷ ${y}`;
            a = result;
          } else {
            // 간단한 복합계산
            const x = randInt(5, 25);
            const y = randInt(5, 25);
            const z = randInt(2, 5);
            if (Math.random() < 0.5) {
              q = `${x} + ${y} × ${z}`;
              a = x + (y * z);
            } else {
              q = `${x} × ${z} + ${y}`;
              a = (x * z) + y;
            }
          }
        }
        
        // 중복 검사
        if (!existingQuestions.has(q)) {
          existingQuestions.add(q);
          additional.push({q: q, a: a});
        }
      }
      
      console.log(`추가 생성된 문제: ${additional.length}개`);
      return additional;
    }

    // 문제 유형별 맞춤 설명 함수
    function getMathTipForQuestion(question, answer, age) {
      const q = question.toLowerCase();
      
      if (age <= 4) {
        // 3-4세: 기초 설명
        if (q.includes('+')) {
          const parts = q.split('+');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          return `🧸 <strong>더하기 설명:</strong><br>
          ${question}를 손가락으로 세어보세요!<br>
          왼손으로 ${a}개, 오른손으로 ${b}개를 펴고<br>
          모두 세어보면 ${answer}개가 나와요!<br>
          💡 블록이나 장난감으로도 해보세요!`;
        } else if (q.includes('-')) {
          const parts = q.split('-');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          return `🍎 <strong>빼기 설명:</strong><br>
          ${a}개에서 ${b}개를 빼는 거예요!<br>
          ${a}개의 사탕이 있는데 ${b}개를 먹으면<br>
          ${answer}개가 남아요!<br>
          💡 하나씩 없애면서 세어보세요!`;
        }
      } else if (age >= 5 && age <= 6) {
        // 5-6세: 10 이하 연산
        if (q.includes('+')) {
          const parts = q.split('+');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          if (answer === 10) {
            return `🎯 <strong>10 만들기:</strong><br>
            ${a} + ${b} = 10<br>
            10을 만드는 짝꿍 숫자들이에요!<br>
            ${a}과 ${b}는 10의 좋은 친구들이랍니다.<br>
            💡 10의 짝꿍들을 외우면 계산이 빨라져요!`;
          } else {
            return `⚡ <strong>덧셈 비법:</strong><br>
            ${a} + ${b} = ${answer}<br>
            큰 수 ${Math.max(a,b)}부터 세고, 작은 수 ${Math.min(a,b)}만큼 더 세어보세요!<br>
            ${Math.max(a,b)}... ${Math.max(a,b)+1}, ${Math.max(a,b)+2}... = ${answer}<br>
            💡 큰 수부터 시작하면 더 쉬워요!`;
          }
        } else if (q.includes('-')) {
          const parts = q.split('-');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `🔄 <strong>뺄셈 비법:</strong><br>
          ${a} - ${b} = ${answer}<br>
          ${a}에서 ${b}를 빼는 방법:<br>
          ${a}부터 거꾸로 세어보세요: ${a}에서 ${b}만큼 뒤로!<br>
          💡 또는 "${b} + ? = ${a}"로 생각해보세요!`;
        }
      } else if (age >= 7 && age <= 8) {
        // 7-8세: 받아올림/받아내림, 곱셈
        if (q.includes('+')) {
          const parts = q.split('+');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          if (answer > 10) {
            return `🎯 <strong>받아올림 마스터:</strong><br>
            ${a} + ${b} = ${answer}<br>
            일의 자리: ${a%10} + ${b%10} = ${(a%10)+(b%10)} → ${((a%10)+(b%10)) >= 10 ? '받아올림 1' : '그대로'}<br>
            십의 자리: ${Math.floor(a/10)} + ${Math.floor(b/10)} ${((a%10)+(b%10)) >= 10 ? '+ 1' : ''} = ${Math.floor(answer/10)}<br>
            💡 일의 자리부터 차근차근 계산하세요!`;
          } else {
            return `⚡ <strong>한 자리 덧셈:</strong><br>
            ${a} + ${b} = ${answer}<br>
            간단한 덧셈이에요!<br>
            💡 10의 보수를 활용하면 더 빨라져요!`;
          }
        } else if (q.includes('-')) {
          const parts = q.split('-');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          if (a > 10 && b > (a%10)) {
            return `🎭 <strong>받아내림 비법:</strong><br>
            ${a} - ${b} = ${answer}<br>
            일의 자리가 부족해서 십의 자리에서 10을 빌려왔어요!<br>
            ${a} = ${Math.floor(a/10)-1}${(a%10)+10} 로 바꾸고<br>
            ${(a%10)+10} - ${b} = ${((a%10)+10)-b}, 십의 자리는 ${Math.floor(a/10)-1}<br>
            💡 십의 자리에서 1을 빌려서 일의 자리에 10을 더해요!`;
          } else {
            return `🔄 <strong>간단한 뺄셈:</strong><br>
            ${a} - ${b} = ${answer}<br>
            ${a}에서 ${b}만큼 빼면 ${answer}가 남아요!<br>
            💡 거꾸로 생각하면 ${answer} + ${b} = ${a}예요!`;
          }
        } else if (q.includes('×')) {
          const parts = q.split('×');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `🚀 <strong>곱셈 설명:</strong><br>
          ${a} × ${b} = ${answer}<br>
          ${a}을 ${b}번 더하는 거예요!<br>
          ${Array.from({length: b}, (_, i) => a).join(' + ')} = ${answer}<br>
          💡 구구단을 외우면 바로바로 계산할 수 있어요!`;
        }
      } else if (age >= 9 && age <= 10) {
        // 9-10세: 구구단, 두 자리 사칙연산
        if (q.includes('+')) {
          const parts = q.split('+');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `🔄 <strong>두 자리 덧셈:</strong><br>
          ${a} + ${b} = ${answer}<br>
          십의 자리: ${Math.floor(a/10)} + ${Math.floor(b/10)} = ${Math.floor(a/10) + Math.floor(b/10)}<br>
          일의 자리: ${a%10} + ${b%10} = ${(a%10) + (b%10)} ${(a%10) + (b%10) >= 10 ? '→ 받아올림!' : ''}<br>
          💡 자리별로 나누어서 계산하면 쉬워요!`;
        } else if (q.includes('-')) {
          const parts = q.split('-');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `🔄 <strong>두 자리 뺄셈:</strong><br>
          ${a} - ${b} = ${answer}<br>
          십의 자리: ${Math.floor(a/10)} - ${Math.floor(b/10)} = ${Math.floor(a/10) - Math.floor(b/10)}<br>
          일의 자리: ${a%10} - ${b%10} = ${(a%10) - (b%10)} ${(a%10) < (b%10) ? '→ 받아내림!' : ''}<br>
          💡 일의 자리가 부족하면 십의 자리에서 빌려오세요!`;
        } else if (q.includes('×')) {
          const parts = q.split('×');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `⭐ <strong>구구단 활용:</strong><br>
          ${a} × ${b} = ${answer}<br>
          ${a}단: ${a} × ${b} = ${answer}<br>
          또는 ${b}단: ${b} × ${a} = ${answer}<br>
          💡 구구단을 외우면 곱셈이 쉬워져요!`;
        } else if (q.includes('÷')) {
          const parts = q.split('÷');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `🔄 <strong>나눗셈 = 거꾸로 곱셈:</strong><br>
          ${a} ÷ ${b} = ${answer}<br>
          "${b} × ? = ${a}"를 생각해보세요!<br>
          ${b} × ${answer} = ${a} ✓<br>
          💡 나눗셈은 곱셈표를 거꾸로 사용하는 거예요!`;
        }
      } else {
        // 11-13세: 복합 계산, 고급 연산
        if (q.includes('(') && q.includes(')')) {
          return `🎭 <strong>복합계산 순서:</strong><br>
          ${question} = ${answer}<br>
          1단계: 괄호 안부터 계산하세요!<br>
          2단계: 곱셈과 나눗셈을 먼저<br>
          3단계: 덧셈과 뺄셈을 나중에<br>
          💡 계산 순서: ( ) → × ÷ → + -`;
        } else if (q.includes('×') && (q.includes('+') || q.includes('-'))) {
          return `🧩 <strong>사칙혼합연산:</strong><br>
          ${question} = ${answer}<br>
          곱셈을 먼저 계산하고, 그 다음에 덧셈/뺄셈!<br>
          순서를 지키는 것이 중요해요.<br>
          💡 곱셈×나눗셈이 덧셈+뺄셈보다 우선이에요!`;
        } else if (q.includes('+')) {
          const parts = q.split('+');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `🔄 <strong>세 자리 덧셈:</strong><br>
          ${a} + ${b} = ${answer}<br>
          백의 자리 + 십의 자리 + 일의 자리로 나누어 계산!<br>
          각 자리별로 더하고 받아올림을 처리하세요.<br>
          💡 큰 수도 자리별로 나누면 쉬워져요!`;
        } else if (q.includes('-')) {
          const parts = q.split('-');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `🔄 <strong>세 자리 뺄셈:</strong><br>
          ${a} - ${b} = ${answer}<br>
          각 자리별로 빼고, 부족하면 윗자리에서 빌려오세요!<br>
          검산: ${answer} + ${b} = ${a} ✓<br>
          💡 뺄셈 후에는 덧셈으로 검산해보세요!`;
        } else if (q.includes('×')) {
          const parts = q.split('×');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `🎯 <strong>큰 수 곱셈:</strong><br>
          ${a} × ${b} = ${answer}<br>
          분해해서 계산하면 쉬워요!<br>
          예: 23 × 4 = (20 + 3) × 4 = 20×4 + 3×4 = 80 + 12 = 92<br>
          💡 큰 수를 십의 자리와 일의 자리로 나누어 계산하세요!`;
        } else if (q.includes('÷')) {
          const parts = q.split('÷');
          const a = parseInt(parts[0].trim());
          const b = parseInt(parts[1].split('=')[0].trim());
          
          return `📦 <strong>큰 수 나눗셈:</strong><br>
          ${a} ÷ ${b} = ${answer}<br>
          나누어지는 수를 작은 단위로 쪼개서 계산하거나<br>
          "${b} × ? = ${a}"로 생각해보세요!<br>
          💡 몫 × 나누는수 + 나머지 = 나누어지는수로 검산하세요!`;
        }
      }
      
      // 기본 설명 (매칭되지 않는 경우)
      return `💡 <strong>문제 해설:</strong><br>
      ${question} = ${answer}<br>
      이 문제의 정답은 ${answer}입니다.<br>
      천천히 다시 계산해보세요!<br>
      💪 틀려도 괜찮아요. 연습하면 늘어나요!`;
    }

    // 오프닝 비디오 관련 요소들
    const openingContainer = document.getElementById('openingVideo');
    const gameContainer = document.getElementById('gameContainer');
    const skipButton = document.getElementById('skipButton');
    const openingVideoPlayer = document.getElementById('openingVideoPlayer');
    let videoTimeoutId = null;
    let gameStarted = false;

    // 게임 화면 표시 함수
    function showGame() {
      if (gameStarted) return; // 이미 게임이 시작된 경우 중복 실행 방지
      gameStarted = true;
      
      console.log('게임 시작');
      openingContainer.style.display = 'none';
      gameContainer.style.display = 'flex';
      startBackgroundMusic();
      
      // 타임아웃 정리
      if (videoTimeoutId) {
        clearTimeout(videoTimeoutId);
        videoTimeoutId = null;
      }
    }

    // 오프닝 비디오 종료 시 자동으로 게임 시작
    openingVideoPlayer.addEventListener('ended', function() {
      console.log('비디오 재생 완료 - 게임 시작');
      showGame();
    });

    // 건너뛰기 버튼 클릭 시
    skipButton.addEventListener('click', function() {
      console.log('건너뛰기 버튼 클릭됨');
      openingVideoPlayer.pause();
      openingVideoPlayer.currentTime = 0;
      showGame();
    });

    // 오프닝 비디오 로드 시 볼륨 설정
    openingVideoPlayer.addEventListener('loadedmetadata', function() {
      console.log('비디오 메타데이터 로드됨, 길이:', openingVideoPlayer.duration + '초');
      openingVideoPlayer.volume = 1.0;
      openingVideoPlayer.muted = false;
    });

    // 자동재생 시도
    function tryAutoplay() {
      if (gameStarted) return;
      
      openingVideoPlayer.play().then(() => {
        console.log('비디오 자동재생 성공');
        // 자동재생 성공 시 타임아웃 해제
        if (videoTimeoutId) {
          clearTimeout(videoTimeoutId);
          videoTimeoutId = null;
        }
      }).catch(e => {
        console.log('자동재생이 차단되었습니다:', e);
        // 자동재생이 차단된 경우 클릭하여 재생하도록 안내
        const playButton = document.createElement('button');
        playButton.textContent = '▶ 영상 재생하기';
        playButton.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          padding: 20px 40px;
          font-size: 20px;
          background: #66b5f6;
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          z-index: 1002;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        `;
        playButton.onclick = function() {
          openingVideoPlayer.play().then(() => {
            playButton.remove();
            // 수동 재생 성공 시 타임아웃 해제
            if (videoTimeoutId) {
              clearTimeout(videoTimeoutId);
              videoTimeoutId = null;
            }
          }).catch(err => {
            console.log('수동 재생도 실패:', err);
            playButton.remove();
            showGame();
          });
        };
        openingContainer.appendChild(playButton);
      });
    }

    // 오프닝 비디오 오류 시 게임 시작
    openingVideoPlayer.addEventListener('error', function(e) {
      console.log('비디오 재생 오류:', e);
      setTimeout(() => {
        showGame();
      }, 1000);
    });

    // 비디오 파일이 없거나 로드되지 않을 경우에만 타임아웃
    videoTimeoutId = setTimeout(() => {
      if (!gameStarted && openingContainer.style.display !== 'none') {
        console.log('비디오 로드 시간 초과 - 게임 시작');
        showGame();
      }
    }, 10000); // 10초로 증가

    // 축하 메시지 모달 관련
    const congratsModal = document.getElementById('congratsModal');
    const giftButton = document.getElementById('giftButton');
    const congratsSound = document.getElementById('congratsSound');
    const celebrationContainer = document.getElementById('celebrationVideo');
    const closeVideoBtn = document.getElementById('closeVideoBtn');
    const bgMusic = document.getElementById('bgMusic');

    // 게임 시작 시 배경음악 재생
    function startBackgroundMusic() {
      if (!bgMusicStarted) {
        bgMusic.volume = 0.4;
        bgMusic.play().catch(e => {
          console.log('배경음악 자동재생이 차단되었습니다. 사용자 상호작용 후 재생됩니다.');
        });
        bgMusicStarted = true;
      }
    }

    // 축하 메시지 표시 함수
    function showCongratsModal() {
      bgMusic.pause();
      congratsModal.style.display = 'flex';
      
      congratsSound.play().catch(e => {
        console.log('박수소리 재생 실패:', e);
      });
    }

    // 선물받기 버튼 클릭 이벤트
    giftButton.addEventListener('click', function() {
      congratsModal.style.display = 'none';
      playCelebrationVideo();
    });

    // 축하 영상 재생 함수
    function playCelebrationVideo() {
      const randomIndex = Math.floor(Math.random() * celebrationVideos.length);
      const videoId = celebrationVideos[randomIndex];
      
      const celebrationIframe = document.getElementById('celebrationPlayer');
      celebrationIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&controls=1&modestbranding=1&rel=0&enablejsapi=1`;
      
      celebrationContainer.style.display = 'flex';
    }

    // 축하 영상 닫기
    closeVideoBtn.addEventListener('click', function() {
      const celebrationIframe = document.getElementById('celebrationPlayer');
      celebrationIframe.src = '';
      celebrationContainer.style.display = 'none';
      bgMusic.play();
    });

    // 결과 메시지 함수
    function getResultMsg(rate) {
      if (rate >= 90) return '우수해요! 수학천재! 👑🦖';
      if (rate >= 80) return '조금만 더 하면 90%도 가능해요! 화이팅! 🌈';
      return '70%가 넘을 때까지 조금 더 연습해요! 재도전 Go! 🚍👑';
    }

    // 정답 확인 함수
    function checkAnswer() {
      const userAns = document.getElementById('answerInput').value.trim();
      const q = quiz.questions[quiz.current];
      
      if (userAns === "") { 
        document.getElementById('feedback').textContent = "답을 입력해 주세요!"; 
        return; 
      }
      
      if (Number(userAns) === q.a) {
        // 정답 처리
        quiz.correct++;
        quiz.consecutiveCorrect++;
        quiz.consecutiveWrong = 0;
        
        let message;
        if (quiz.consecutiveCorrect >= 3) {
          message = consecutiveMessages[randInt(0, consecutiveMessages.length - 1)];
        } else if (q.a > 50 || (quiz.age >= 11 && q.q.includes('×') && q.a > 100)) {
          message = hardCorrectMessages[randInt(0, hardCorrectMessages.length - 1)];
        } else {
          message = correctMessages[randInt(0, correctMessages.length - 1)];
        }
        
        document.getElementById('feedback').textContent = message;
        document.getElementById('feedback').style.color = '#28a745';
        
        // 효과음 재생
        if (!applauseCooldown) {
          const applauseSound = document.getElementById('applauseSound');
          applauseSound.currentTime = 0;
          applauseSound.play().catch(e => {
            console.log('효과음 재생 실패:', e);
          });
          applauseCooldown = true;
          setTimeout(() => { applauseCooldown = false; }, 1500);
        }
        
        // 정답 시 1.2초 후 자동으로 다음 문제
        document.getElementById('submitAnswerBtn').textContent = '다음 문제';
        document.getElementById('submitAnswerBtn').disabled = true;
        
        setTimeout(() => {
          goToNextQuestion();
        }, 1200);
        
      } else {
        // 오답 처리
        quiz.consecutiveCorrect = 0;
        quiz.consecutiveWrong++;
        
        let message;
        if (quiz.consecutiveWrong >= 3) {
          message = consecutiveWrongMessages[randInt(0, consecutiveWrongMessages.length - 1)];
        } else {
          message = wrongMessages[randInt(0, wrongMessages.length - 1)];
        }
        
        document.getElementById('feedback').textContent = `${message} (정답: ${q.a})`;
        document.getElementById('feedback').style.color = '#dc3545';
        
        // 수학 팁 표시 (문제별 맞춤 설명)
        const customTip = getMathTipForQuestion(q.q, q.a, quiz.age);
        document.getElementById('mathTip').innerHTML = customTip;
        document.getElementById('mathTip').style.display = 'block';
        
        // 오답 시 수동으로 다음 문제로 (자동 넘어가기 제거)
        document.getElementById('submitAnswerBtn').textContent = '다음 문제';
        document.getElementById('submitAnswerBtn').disabled = false;
        
        // 버튼 클릭 이벤트를 다음 문제로 변경
        const btn = document.getElementById('submitAnswerBtn');
        btn.removeEventListener('click', checkAnswer);
        btn.addEventListener('click', goToNextQuestion);
      }
    }

    // 다음 문제로 이동하는 함수
    function goToNextQuestion() {
      quiz.current++;
      if (quiz.current >= 20) {
        finishQuiz();
      } else {
        showQuestion();
      }
    }

    // 게임 시작
    document.getElementById('startQuizBtn').onclick = function() {
      const age = parseInt(document.getElementById('ageSelect').value);
      if (!age || age < 3 || age > 13) { 
        alert('3~13세 나이만 선택 가능합니다!'); 
        return; 
      }
      
      quiz.age = age;
      quiz.questions = makeQuestions(age);
      quiz.current = 0;
      quiz.correct = 0;
      quiz.consecutiveCorrect = 0;
      quiz.consecutiveWrong = 0;
      
      document.getElementById('ageSection').style.display = 'none';
      document.getElementById('quizSection').style.display = 'block';
      document.getElementById('resultSection').style.display = 'none';
      showQuestion();
      
      // 배경음악 시작
      startBackgroundMusic();
    };

    // 문제 표시
    function showQuestion() {
      const qinfo = quiz.questions[quiz.current];
      document.getElementById('questionNum').textContent = `문제 ${quiz.current + 1} / 20`;
      document.getElementById('questionText').textContent = qinfo.q + ' = ?';
      document.getElementById('answerInput').value = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('mathTip').style.display = 'none';
      document.getElementById('answerInput').focus();
      document.getElementById('submitAnswerBtn').textContent = '정답 확인';
      document.getElementById('submitAnswerBtn').disabled = false;
      
      // 버튼 이벤트 리스너를 완전히 새로 설정
      const btn = document.getElementById('submitAnswerBtn');
      // 기존 이벤트 리스너 모두 제거
      btn.replaceWith(btn.cloneNode(true));
      // 새로운 버튼 참조 가져오기
      const newBtn = document.getElementById('submitAnswerBtn');
      // 정답 확인 이벤트 추가
      newBtn.addEventListener('click', checkAnswer);
    }

    // 엔터키 처리
    document.getElementById('answerInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const btn = document.getElementById('submitAnswerBtn');
        if (!btn.disabled) {
          btn.click();
        }
      }
    });

    // 퀴즈 완료
    function finishQuiz() {
      document.getElementById('quizSection').style.display = 'none';
      document.getElementById('resultSection').style.display = 'block';
      document.getElementById('correctCount').textContent = quiz.correct;
      document.getElementById('totalCount').textContent = '20';
      
      const rate = Math.round(quiz.correct / 20 * 100);
      document.getElementById('accuracy').textContent = rate;
      document.getElementById('resultMsg').textContent = getResultMsg(rate);
      document.getElementById('retryBtn').style.display = (rate < 70) ? 'inline-block' : 'none';
      
      // 90점 이상이면 2초 후 축하 메시지 모달 표시
      if (rate >= 90) {
        setTimeout(() => {
          showCongratsModal();
        }, 2000);
      }
    }

    // 재도전
    document.getElementById('retryBtn').onclick = function() {
      quiz.current = 0;
      quiz.correct = 0;
      quiz.consecutiveCorrect = 0;
      quiz.consecutiveWrong = 0;
      quiz.questions = makeQuestions(quiz.age);
      
      document.getElementById('ageSection').style.display = 'none';
      document.getElementById('quizSection').style.display = 'block';
      document.getElementById('resultSection').style.display = 'none';
      showQuestion();
    };

    // 처음으로
    document.getElementById('restartBtn').onclick = function() {
      location.reload();
    };

    // 음소거 토글
    document.getElementById('muteBtn').onclick = function() {
      isSoundOn = !isSoundOn;
      bgMusic.muted = !isSoundOn;
      this.textContent = isSoundOn ? '🔊' : '🔇';
    };

    // 정답 확인 버튼 초기 이벤트 (게임 시작 시에만)
    document.addEventListener('DOMContentLoaded', function() {
      const initialBtn = document.getElementById('submitAnswerBtn');
      if (initialBtn) {
        initialBtn.addEventListener('click', checkAnswer);
      }
    });

    // 페이지 로드 시 오프닝 비디오부터 시작
    window.addEventListener('load', function() {
      console.log('페이지 로드 완료 - 오프닝 비디오 시작');
      // 오프닝 비디오가 먼저 표시됨
      openingContainer.style.display = 'flex';
      gameContainer.style.display = 'none';
      
      // 페이지 로드 후 자동재생 시도
      setTimeout(() => {
        tryAutoplay();
      }, 500);
    });

  </script>
</body>
</html>
